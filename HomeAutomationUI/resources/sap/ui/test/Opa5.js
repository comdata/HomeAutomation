/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2015 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(['jquery.sap.global','sap/ui/thirdparty/URI','./Opa','./OpaPlugin','./PageObjectFactory','sap/ui/qunit/QUnitUtils','sap/ui/base/Object','sap/ui/Device','./matchers/Matcher','./matchers/AggregationFilled','./matchers/PropertyStrictEquals','./matchers/Properties','./matchers/Ancestor','./matchers/AggregationContainsPropertyEqual'],function($,U,O,a,P,b,c,D,M,A,d){var p=new a(),f=null,F=null,o=null,e=null,g=null,h=false,r=false,u=false;var j=c.extend("sap.ui.test.Opa5",jQuery.extend({},O.prototype,{constructor:function(){O.apply(this,arguments);}}));function s(S,T){g=$("#OpaFrame");var i=jQuery.sap.getModulePath("sap.ui.test.OpaFrame",".css");jQuery.sap.includeStyleSheet(i);if(!g.length){g=$('<iframe id="OpaFrame" class="opaFrame" src="'+S+'"></iframe>');$("body").append(g);}if(g[0].contentDocument&&g[0].contentDocument.readyState==="complete"){m();}else{g.on("load",m);}return this.waitFor({viewName:null,controlType:null,id:null,searchOpenDialogs:false,check:function(){if(!h){return;}return q();},timeout:T||80,errorMessage:"unable to load the iframe with the url: "+S});}j.iStartMyAppInAFrame=s;j.prototype.iStartMyAppInAFrame=s;function t(){return this.waitFor({success:function(){x();}});}j.iTeardownMyAppFrame=t;j.prototype.iTeardownMyAppFrame=t;j.prototype.waitFor=function(i){i=$.extend({},O.config,i);var y=i.check,C=null,z,B=i.success,E,R;i.check=function(){if(!this._modifyControlType(i)){return false;}C=j.getPlugin().getMatchingControls(i);if((i.viewName||i.searchOpenDialogs)&&!i.id&&!C||(C&&C.length===0)){jQuery.sap.log.debug("found no controls in view: "+i.viewName+" with controlType "+i.sOriginalControlType,"","Opa");return false;}if(typeof i.id==="string"&&!C){jQuery.sap.log.debug("found no control with the id "+i.id,"","Opa");return false;}if(i.id instanceof RegExp&&!C.length){jQuery.sap.log.debug("found no control with the id regex"+i.id);return false;}if($.isArray(i.id)&&(!C||C.length!==i.id.length)){if(C&&C.length){jQuery.sap.log.debug("found not all controls with the ids "+i.id+" onlyFound the controls: "+C.map(function(I){return I.sId;}));}else{jQuery.sap.log.debug("found no control with the id  "+i.id);}return false;}if(i.sOriginalControlType&&!C.length){jQuery.sap.log.debug("found no controls with the type  "+i.sOriginalControlType,"","Opa");return false;}z=this._checkMatchers(i.matchers);var G;if(z&&z.length){if(!$.isArray(C)){G=1;E=[C];}else{E=C;}var H=[];E.forEach(function(I){var J=this._doesValueMatch(z,I);if(J){if(J===true){H.push(I);}else{H.push(J);}}},this);if(!H.length){jQuery.sap.log.debug("all results were filtered out by the matchers - skipping the check");return false;}if(G===1){R=H[0];}else{R=H;}}else{R=C;}if(y){return this._executeCheck(y,R);}return true;};if(B){i.success=function(){B.call(this,R);};}return O.prototype.waitFor.call(this,i);};j.getPlugin=function(){return o||p;};j.getJQuery=function(){return F;};j.getWindow=function(){return f;};j.getUtils=function(){return e;};j.getHashChanger=function(){if(!f){return null;}f.jQuery.sap.require("sap.ui.core.routing.HashChanger");return f.sap.ui.core.routing.HashChanger.getInstance();};j.extendConfig=O.extendConfig;j.resetConfig=function(){O.resetConfig();O.extendConfig({viewNamespace:"",arrangements:new j(),actions:new j(),assertions:new j(),visible:true,_stackDropCount:1});};j.emptyQueue=O.emptyQueue;j.getContext=O.getContext;j.matchers={};j.matchers.Matcher=M;j.matchers.AggregationFilled=A;j.matchers.PropertyStrictEquals=d;j.createPageObjects=function(i){return P.create(i,j);};j.prototype._doesValueMatch=function(y,V){var z=V;var I=true;jQuery.each(y,function(i,B){var C=B.isMatching(V);if(C){if(C!==true){V=C;}}else{I=false;return false;}});if(I){return(z===V)?true:V;}else{return false;}};j.prototype._checkMatchers=function(i){var y=[];if($.isArray(i)){y=i;}else if(i){y=[i];}y=y.map(function(z){if(z instanceof j.matchers.Matcher){return z;}else if(typeof z=="function"){return{isMatching:z};}jQuery.sap.log.error("Matchers where defined, but they where neither an array nor a single matcher: "+i);return undefined;}).filter(function(z){return!!z;});return y;};j.prototype._modifyControlType=function(i){var C=i.controlType;if(typeof C!=="string"){return true;}i.sOriginalControlType=C;var W=f||window;var y=W.jQuery.sap.getObject(C);if(!y){jQuery.sap.log.debug("The control type "+C+" is undefined. Skipped check and will wait until it is required",this);return false;}if(y._sapUiLazyLoader){jQuery.sap.log.debug("The control type "+C+" is currently a lazy stub. Skipped check and will wait until it is invoked",this);return false;}i.controlType=y;return true;};j.prototype._executeCheck=function(C,i){jQuery.sap.log.debug("Opa is executing the check: "+C);var R=C.call(this,i);jQuery.sap.log.debug("Opa check was "+R);return R;};j.resetConfig();function k(){F=f.jQuery;l("sap.ui.test");F.sap.require("sap.ui.test.OpaPlugin");o=new f.sap.ui.test.OpaPlugin();l("sap.ui.qunit.QUnitUtils");f.jQuery.sap.require("sap.ui.qunit.QUnitUtils");e=f.sap.ui.qunit.QUnitUtils;}function l(i){var y=jQuery.sap.getModulePath(i);var z=new U(y).absoluteTo(document.baseURI).search("").toString();F.sap.registerModulePath(i,z);}function m(){f=g[0].contentWindow;n();h=true;q();}function n(){if(D.browser.internet_explorer&&D.browser.version===9){return;}var i=f.onerror;f.onerror=function(E,y,L){if(i){i.apply(this,arguments);}throw"OpaFrame error message: "+E+" url: "+y+" line: "+L;};}function q(){if(u){return true;}if(f&&f.sap&&f.sap.ui&&f.sap.ui.getCore){if(!r){f.sap.ui.getCore().attachInit(v);}r=true;}return u;}function v(){u=true;k();w();}function w(){f.jQuery.sap.require("sap.ui.thirdparty.hasher");f.jQuery.sap.require("sap.ui.core.routing.History");f.jQuery.sap.require("sap.ui.core.routing.HashChanger");var H=new f.sap.ui.core.routing.HashChanger(),i=new f.sap.ui.core.routing.History(H),y=f.hasher,z=y.setHash,B=y.getHash,C,E=f.history.go;y.replaceHash=function(J){var K=this.getHash();C=J;H.fireEvent("hashReplaced",{sHash:J});this.changed.dispatch(J,K);};y.setHash=function(J){var R=B.call(this);C=J;H.fireEvent("hashSet",{sHash:J});z.apply(this,arguments);if(R===this.getHash()){this.changed.dispatch(R,i.aHistory[i.iHistoryPosition]);}};y.getHash=function(){if(C===undefined){return B.apply(this,arguments);}return C;};H.init();function G(){var N=i.aHistory[i.iHistoryPosition],J=i.getPreviousHash();C=J;y.changed.dispatch(J,N);}function I(){var N=i.aHistory[i.iHistoryPosition+1],J=i.aHistory[i.iHistoryPosition];if(N===undefined){jQuery.sap.log.error("Could not navigate forwards, there is no history entry in the forwards direction",this);return;}C=N;y.changed.dispatch(N,J);}f.history.back=G;f.history.forward=I;f.history.go=function(S){if(S===-1){G();return;}else if(S===1){I();return;}jQuery.sap.log.error("Using history.go with a number greater than 1 is not supported by OPA5",this);return E.apply(f.history,arguments);};}function x(){g.remove();f=null;F=null;o=null;e=null;r=false;h=false;u=false;}$(function(){g=$("#OpaFrame");g.on("load",m);$("body").height("100%");$("html").height("100%");});return j;});
