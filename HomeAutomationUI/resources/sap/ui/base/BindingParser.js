/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2015 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(['jquery.sap.global','./ExpressionParser','sap/ui/model/BindingMode','jquery.sap.script'],function(q,E,B){"use strict";var r=/^\{\s*[a-zA-Z_][a-zA-Z0-9_]*\s*:/;var a=/(\\[\\\{\}])|(\{)/g;var b=/([\\\{\}])/g;function f(o){return o;}function c(F,j){var k=function(){var R=[],l=F.length,i;for(i=0;i<l;i++){if(typeof F[i]==="number"){if(j){R.push(j[F[i]].apply(this,arguments));}else{R.push(arguments[F[i]]);}}else{R.push(F[i]);}}return R.join('');};k.textFragments=F;return k;}function d(p){var P=p.indexOf(">"),o={path:p};if(P>0){o.model=p.slice(0,P);o.path=p.slice(P+1);}return o;}function e(o,F){var i=[],p=[];o.parts.forEach(function(j){var k,l=j.formatter||f,s=p.length;if(j.parts){p=p.concat(j.parts);}else{p.push(j);}k=p.length;i.push(function(){return l.apply(this,Array.prototype.slice.call(arguments,s,k));});});o.parts=p;o.formatter=c(F,i);}function g(i,I,s){var p=q.sap.parseJS,P,j,n;function k(o,u){if(typeof o[u]==="string"){var n=o[u];if(q.sap.startsWith(o[u],".")){o[u]=q.proxy(q.sap.getObject(o[u].slice(1),undefined,i.oContext),i.oContext);}else{o[u]=q.sap.getObject(o[u]);}if(typeof(o[u])!=="function"){if(i.bTolerateFunctionsNotFound){i.aFunctionsNotFound=i.aFunctionsNotFound||[];i.aFunctionsNotFound.push(n);}else{q.sap.log.error(u+" function "+n+" not found!");}}}}function l(o,u){var F;if(typeof o[u]==="string"){if(q.sap.startsWith(o[u],".")){F=q.sap.getObject(o[u].slice(1),undefined,i.oContext);}else{F=q.sap.getObject(o[u]);}if(typeof F==="function"){o[u]=new F(o.formatOptions,o.constraints);}else{o[u]=F;}delete o.formatOptions;delete o.constraints;}}function m(o,u){if(!(q.isPlainObject(o[u]))){return;}q.each(o[u],function(n,O){k(o[u],n);});}function t(o,u,v){var F;if(!(typeof o[u]==="object"||q.isArray(o[u]))){return;}if(q.isArray(o[u])){q.each(o[u],function(w,O){t(o[u],w,u);});}else{if(u==="filters"||v==="filters"){F=q.sap.getObject("sap.ui.model.Filter");}else if(u==="sorter"||v==="sorter"){F=q.sap.getObject("sap.ui.model.Sorter");k(o[u],"group");}if(F){o[u]=new F(o[u]);}}}if(r.test(I.slice(s))){P=p(I,s);l(P.result,'type');t(P.result,'filters');t(P.result,'sorter');m(P.result,'events');k(P.result,'formatter');k(P.result,'factory');k(P.result,'groupHeaderFactory');i.bNotJustSimple=true;for(n in P.result){if(n!=="formatter"&&n!=="parts"){i.bMoreThanExpression=true;break;}}return P;}j=I.indexOf('}',s);if(j<s){throw new SyntaxError("no closing braces found in '"+I+"' after pos:"+s);}return{result:d(I.slice(s+1,j)),at:j+1};}var h={};h._keepBindingStrings=false;h.simpleParser=function(s,C){if(q.sap.startsWith(s,"{")&&q.sap.endsWith(s,"}")){return d(s.slice(1,-1));}};h.simpleParser.escape=function(v){return v;};h.complexParser=function(s,C,u,t){var o={parts:[]},i={oContext:C,bTolerateFunctionsNotFound:t,bMoreThanExpression:false,bNotJustSimple:false},F=[],U,p=0,m,j;function k(I,S,l){var n=E.parse(g.bind(null,i),s,S);if(I.charAt(n.at)!=="}"){throw new SyntaxError("Expected '}' and instead saw '"+I.charAt(n.at)+"' in expression binding "+I+" at position "+n.at);}n.at+=1;if(n.result){i.bNotJustSimple=true;n.result.mode=l;}else{F[F.length-1]=String(n.constant);U=true;}return n;}a.lastIndex=0;while((m=a.exec(s))!==null){if(p<m.index){F.push(s.slice(p,m.index));}if(m[1]){F.push(m[1].slice(1));U=true;}else{F.push(o.parts.length);if(s.indexOf(":=",m.index)===m.index+1){j=k(s,m.index+3,B.OneTime);}else if(s.charAt(m.index+1)==="="){j=k(s,m.index+2,B.OneWay);}else{j=g(i,s,m.index);}if(j.result){o.parts.push(j.result);}a.lastIndex=j.at;}p=a.lastIndex;}if(p<s.length){F.push(s.slice(p));}if(o.parts.length>0){if(F.length===1){o=o.parts[0];}else if(i.bNotJustSimple&&!i.bMoreThanExpression){e(o,F);}else{o.formatter=c(F);}if(h._keepBindingStrings){o.bindingString=s;}if(i.aFunctionsNotFound){o.functionsNotFound=i.aFunctionsNotFound;}return o;}else if(u&&U){return F.join('');}};h.complexParser.escape=function(v){return v.replace(b,"\\$1");};h.parseExpression=function(i,s){return E.parse(g.bind(null,{}),i,s);};return h;},true);
