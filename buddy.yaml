- pipeline: "HomeAutomation Pipeline"
  trigger_mode: "ON_EVERY_PUSH"
  ref_name: "master"
  actions:
  - action: "mvn install"
    type: "BUILD"
    docker_image_name: "library/maven"
    docker_image_tag: "latest"
    execute_commands:
    - "# Working directory with cloned repository: /homeautomation"
    - "# See More Options for details (link on the bottom)"
    - "#mvn clean"
    - "#cd HomeAutomationBase"
    - "mvn clean"
    - "#mvn -DskipTests=true assembly:single"
    - "echo $MAVEN_OPTS"
    - "export MAVEN_OPTS=\"-Xms1024m -Xmx1536m -XX:MaxPermSize=1024m\""
    - "mvn -DskipTests=true install"
    - "#install"
    - "#cd ../HomeAutomation"
    - "#mvn clean"
    - "#mvn -DskipTests=true assembly:single"
    - "#mvn -DskipTests=true install"
    - "#cd ../HomeAutomationUI"
    - "#mvn clean"
    - "#mvn -DskipTests=true assembly:single"
    - "#mvn -DskipTests=true install"
    cached_dirs:
    - "/root/.m2/repository"
  - action: "Execute: rsync -v -avz -e \"ssh -o StrictHostKeyChecking=no\" ${sshCopydir} ${sshUser}@${sshHost}:${sshPath}"
    type: "BUILD"
    docker_image_name: "library/ubuntu"
    docker_image_tag: "latest"
    execute_commands:
    - "rsync -v -auvz --progress --delete -e \"ssh -o StrictHostKeyChecking=no -p 2223\" /buddy/homeautomation/HomeAutomationUI/target/HomeAutomationUI-0.0.1-SNAPSHOT/* root@apv7nurocvwjnnjl.myfritz.net:/var/lib/tomcat8/webapps/HomeAutomationUI/"
    - "rsync -v -auvz --progress --delete -e \"ssh -o StrictHostKeyChecking=no -p 2223\" /buddy/homeautomation/HomeAutomation/target/HomeAutomation-0.0.1-SNAPSHOT/WEB-INF/* root@apv7nurocvwjnnjl.myfritz.net:/var/lib/tomcat8/webapps/HomeAutomation/WEB-INF/"
    setup_commands:
    - "apt-get update -y && apt-get install -y rsync openssh-client"
  - action: "Upload Web files to apv7nurocvwjnnjl.myfritz.net"
    type: "SFTP"
    input_type: "BUILD_ARTIFACTS"
    local_path: "HomeAutomationUI/target/HomeAutomationUI-0.0.1-SNAPSHOT"
    remote_path: "/var/lib/tomcat8/webapps/HomeAutomationUI/"
    login: "root"
    host: "apv7nurocvwjnnjl.myfritz.net"
    port: "2223"
    authentication_mode: "PUBLIC_KEY"
  - action: "Upload Java files to apv7nurocvwjnnjl.myfritz.net"
    type: "SFTP"
    input_type: "BUILD_ARTIFACTS"
    local_path: "HomeAutomation/target/HomeAutomation-0.0.1-SNAPSHOT/WEB-INF"
    remote_path: "/var/lib/tomcat8/webapps/HomeAutomation/WEB-INF"
    login: "root"
    host: "apv7nurocvwjnnjl.myfritz.net"
    port: "2223"
    authentication_mode: "PUBLIC_KEY"
  - action: "[a] Execute: /etc/init.d/tomcat8 restart"
    type: "SSH_COMMAND"
    login: "root"
    host: "apv7nurocvwjnnjl.myfritz.net"
    port: "2223"
    authentication_mode: "PUBLIC_KEY"
    commands:
    - "/etc/init.d/tomcat8 restart"
  - action: "Send Email notification"
    type: "EMAIL"
    trigger_time: "ON_FAILURE"
    title: "${execution.pipeline.name} execution #${execution.id}"
    content: "HA build failed"
    recipients: "c.mertins@gmail.com"
