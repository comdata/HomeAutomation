/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ui/dt/ElementUtil","sap/ui/rta/Utils","sap/base/Log","sap/ui/rta/util/BindingsExtractor"],function(q,E,R,L,B){"use strict";function _(P,j){var u=q.extend({},P);u.entityName=j.name;var v=P["com.sap.vocabularies.Common.v1.Label"];u.fieldLabel=v&&v.String;var Q=P["com.sap.vocabularies.Common.v1.QuickInfo"];u.quickInfo=Q&&Q.String;var H=P["com.sap.vocabularies.UI.v1.Hidden"];u.hidden=H&&H.Bool==="true";if(!u.hidden){var F=P["com.sap.vocabularies.Common.v1.FieldControl"];if(F){u.hidden=F.EnumMember==="com.sap.vocabularies.Common.v1.FieldControlType/Hidden";}}return u;}function a(P){if(P&&P.type){if(P.type.toLowerCase().indexOf("edm")!==0){return true;}}return false;}function b(O,M,j){return O.reduce(function(u,P){var v=_(P,j);if(a(v)){var C=M.getODataComplexType(v.type);if(C){v=C.property.map(function(w){w=_(w,j);w.bindingPath=v.name+"/"+w.name;w.referencedComplexPropertyName=v.fieldLabel||v.name;return w;});}}else{v.bindingPath=P.name;}return u.concat(v);},[]);}function c(O,j,u){return O.filter(function(P){return!P.hidden;}).filter(function(P){var F=P["com.sap.vocabularies.Common.v1.FieldControl"];var v=F&&F.Path;if(v){var w=j.getBinding(u)instanceof sap.ui.model.ListBinding;if(w){return true;}var x=j.getBindingContext().getProperty(v);return x!==0;}return true;});}function d(j,u){if(!j){return false;}var v=j.getBindingInfo(u);var P=v&&v.path;if(!P){return false;}if(P.indexOf(">")>-1){P=P.split(">").pop();}return P.indexOf("/")===0;}function e(j,u,v){var w;if(u){w=j.getBindingInfo(v);if(typeof w.model==="string"&&w.model!==""){w=undefined;}}else{w=j.getBindingContext();}return w;}function f(j,u){var v=d(j,u);var w=e(j,v,u);if(w){return v?w.path:w.getPath();}}function g(P,C){C.type="custom";if(C.id){C.itemId=P+"--"+C.id;C.key=C.itemId;}return C;}function h(j,u){var M=j.getModel();var D={property:[],navigationProperty:[],navigationEntityNames:[]};if(M){var v=M.getMetadata().getName();if(v==="sap.ui.model.odata.ODataModel"||v==="sap.ui.model.odata.v2.ODataModel"){var w=M.getMetaModel();return w.loaded().then(function(){var x=f(j,u);if(x){var y=w.getMetaContext(x);var O=y.getObject();var z=j.getMetadata().getAggregation();if(z){var C=j.getBindingInfo(z.name);var T=C&&C.template;if(T){var P=j.getBindingPath(z.name);var F=w.getODataAssociationEnd(O,P);var G=F&&F.type;if(G){var H=w.getODataEntityType(G);O=H;}}}D.property=O.property||[];D.property=b(D.property,w,O);D.property=c(D.property,j,u);if(O.navigationProperty){D.navigationProperty=O.navigationProperty;O.navigationProperty.forEach(function(N){var G=(w.getODataAssociationEnd(O,N.name)&&w.getODataAssociationEnd(O,N.name).type);var H=w.getODataEntityType(G);if(H&&H.name){if(D.navigationEntityNames.indexOf(H.name)===-1){D.navigationEntityNames.push(H.name);}}});}}return D;});}}return Promise.resolve(D);}function i(O){return{selected:false,label:O.fieldLabel||O.name,referencedComplexPropertyName:O.referencedComplexPropertyName?O.referencedComplexPropertyName:"",duplicateComplexName:O.duplicateComplexName?O.duplicateComplexName:false,tooltip:O.quickInfo||O.fieldLabel,originalLabel:"",type:"odata",entityType:O.entityName,name:O.name,bindingPath:O.bindingPath};}function k(D){var j=D.element;var u=D.action;var v=D.bindingPathCollection;return{selected:false,label:j.fieldLabel||E.getLabelForElement(j,u.getLabel),tooltip:j.quickInfo||j.name||E.getLabelForElement(j,u.getLabel),referencedComplexPropertyName:j.referencedComplexPropertyName?j.referencedComplexPropertyName:"",duplicateComplexName:j.duplicateComplexName?j.duplicateComplexName:false,bindingPaths:v.bindingPaths,originalLabel:j.renamedLabel&&j.fieldLabel!==j.originalLabel?j.originalLabel:"",type:"invisible",elementId:j.getId()};}function l(j,u,v){if(u&&u!==j){var w=R.getEntityTypeByPath(j.getModel(),f(j,v));return E.findAllSiblingsInContainer(j,u).filter(function(S){var P=f(S,v);if(P){return R.getEntityTypeByPath(S.getModel(),P)===w;}return false;});}return[j];}function m(O){O.forEach(function(u,v,O){if(u["duplicateComplexName"]!==true){for(var j=v+1;j<O.length-1;j++){if(u.fieldLabel===O[j].fieldLabel){u["duplicateComplexName"]=true;O[j]["duplicateComplexName"]=true;}}}});return O;}function n(I,O){return O.some(function(D){return D.fieldLabel===I.fieldLabel;});}function o(j){return Array.isArray(j)&&j.length>0;}function p(j,N,u,v){var w=o(j)&&j.some(function(P){var y=P.trim().replace(/^\//gi,'').split('/');if(y.length>1){return N.indexOf(y.shift())!==-1;}});var x=v.some(function(C){C=C.match(/^\/?([A-Za-z0-9_]+)/)[0];return(u.indexOf(C)>=0);});return w||x;}function r(j,O){return O.filter(function(D){return j.indexOf(D.bindingPath)!==-1;}).pop();}function s(I,O){I.originalLabel=O.fieldLabel||O.label;I.quickInfo=O.quickInfo||O.tooltip;I.name=O.name;if(I.fieldLabel!==I.originalLabel){I.renamedLabel=true;}if(O.referencedComplexPropertyName){I.referencedComplexPropertyName=O.referencedComplexPropertyName;}}function t(I,O,N,j,u){var v=u.bindingPaths;var w=u.bindingContextPaths;var x;return(!o(v)||p(v,N,j,w)||((x=r(v,O))&&(s(I,x)||true)));}var A={enhanceInvisibleElements:function(j,u){var M=j.getModel();var v=u.reveal;var w=u.addODataProperty;var C=u.custom;var D=j.getMetadata().getAggregation();var x=D?D.name:u.aggregation;return Promise.resolve().then(function(){return h(j,x);}).then(function(y){var O=y.property;var z=y.navigationProperty.map(function(N){return N.name;});var F=y.navigationEntityNames;O=m(O);var G=[];var I=v.elements||[];I.forEach(function(H){var J=H.element;var K=H.action;var N=true;var P={};J.fieldLabel=E.getLabelForElement(J,K.getLabel);if(w){if(f(j,x)===f(J,x)){P=B.collectBindingPaths(J,M);J.duplicateComplexName=n(J,O);if(O.length>0){N=t(J,O,z,F,P);}}else if(B.getBindings(J,M).length>0){N=false;}}if(C&&N){C.items.forEach(function(Q){g(j.getParent().getId(),Q);if(Q.itemId===J.getId()){s(J,Q);}});}if(N){G.push({element:J,action:K,bindingPathCollection:P});}});return G;}).then(function(y){return y.map(k);});},getUnboundODataProperties:function(j,u){var D=j.getMetadata().getAggregation();var v=D?D.name:u.action.aggregation;var M=j.getModel();return Promise.resolve().then(function(){return h(j,v);}).then(function(w){var O=w.property;var x=l(j,u.relevantContainer,v);var y=[];x.forEach(function(j){y=y.concat(B.getBindings(j,M));});var F=u.action.filter?u.action.filter:function(){return true;};O=O.filter(function(z){var H=false;if(y){H=y.some(function(C){return(q.isPlainObject(C)?C.parts[0].path:!!C.getPath&&C.getPath())===z.bindingPath;});}return!H&&F(u.relevantContainer,z);});O=m(O);return O;}).then(function(U){return U.map(i);});},getCustomAddItems:function(j,u){return new Promise(function(v){if(Array.isArray(u.items)){v(u.items.map(g.bind(null,j.getParent().getId())).filter(function(C){if(!C.id){L.error("CustomAdd item with label "+C.label+" does not contain an 'id' property","sap.ui.rta.plugin.AdditionalElementsAnalyzer#showAvailableElements");return false;}return!E.getElementInstance(C.itemId);}));}else{v();}});},getFilteredItemsList:function(j){var C=2;if(j[C]){var I=j[0].map(function(u){return u.elementId;});j[C]=j[C].filter(function(u){return!u.itemId||I.indexOf(u.itemId)===-1;});}return j.reduce(function(u,v){return u.concat(v);},[]);}};return A;});
