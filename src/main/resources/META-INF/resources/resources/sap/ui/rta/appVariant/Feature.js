/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/Utils","sap/ui/rta/appVariant/AppVariantUtils","sap/ui/core/BusyIndicator","sap/base/util/UriParameters","sap/ui/fl/registry/Settings","sap/ui/fl/descriptorRelated/api/DescriptorVariantFactory","sap/base/util/merge"],function(F,A,B,U,S,D,m){"use strict";var a;var o;var r;var c;var _;var g=function(){return F.getAppDescriptor(r);};var G=function(){return S.getInstance();};var s=function(){window.onbeforeunload=_;};var t=function(e,h){return o.triggerCatalogPublishing(e,h,true);};var T=function(e){return o.triggerCatalogPublishing(e,null,false);};var R=function(i,C){if(a){A.closeOverviewDialog();return this.onGetOverview(true,C);}else if(!a&&i){B.hide();return this.onGetOverview(true,C);}return Promise.resolve();};var f=function(e,i,C){return e?A.navigateToFLPHomepage():R.call(this,!i,C);};var b=function(e,h){if(e&&e.response&&e.response.IAMId){return o.notifyKeyUserWhenPublishingIsReady(e.response.IAMId,h,true);}return Promise.resolve();};var d=function(e,h){if(e&&e.response&&e.response.IAMId&&e.response.inProgress){return o.notifyKeyUserWhenPublishingIsReady(e.response.IAMId,h,false);}return Promise.resolve();};sap.ui.getCore().getEventBus().subscribe("sap.ui.rta.appVariant.manageApps.controller.ManageApps","navigate",function(){if(a){a.destroy();a=null;}});return{onGetOverview:function(e,l){var h=g();return new Promise(function(i){var C=function(){A.closeOverviewDialog();};sap.ui.require(["sap/ui/rta/appVariant/AppVariantOverviewDialog"],function(j){if(!a){a=new j({idRunningApp:h["sap.app"].id,isOverviewForKeyUser:e,layer:l});}a.attachCancel(C);a.oPopup.attachOpened(function(){i(a);});a.open();});});},isOverviewExtended:function(){var u=U.fromQuery(window.location.search);var M=u.get("sap-ui-xx-app-variant-overview-extended");if(!M){return false;}return M.toLowerCase()==='true';},isManifestSupported:function(){var e=g();return A.getManifirstSupport(e["sap.app"].id).then(function(h){return h.response;}).catch(function(E){var h=A.buildErrorInfo("MSG_APP_VARIANT_FEATURE_FAILED",E);h.overviewDialog=true;return A.showRelevantDialog(h,false);});},isPlatFormEnabled:function(e,C,l){r=e;c=l;var h=g();if(h["sap.app"]&&h["sap.app"].id){if(F.getUshellContainer()&&!A.isStandAloneApp()&&C==="CUSTOMER"){var i;if(h["sap.app"].crossNavigation&&h["sap.app"].crossNavigation.inbounds){i=A.getInboundInfo(h["sap.app"].crossNavigation.inbounds);}else{i=A.getInboundInfo();}if(i){return true;}}}return false;},getAppVariantDescriptor:function(e){r=e;var h=g();if(h["sap.app"]&&h["sap.app"].id){return D.loadAppVariant(h["sap.app"].id,false);}return Promise.resolve(false);},onSaveAs:function(e,C,h,i){var I;var j=[];var k;var l=g();if(i&&i["sap.app"].id===l["sap.app"].id){C=true;l=m({},i);i=null;}return new Promise(function(n){var p=function(){return o.processSaveAsDialog(l,e);};var q=function(H){B.show();return o.createAllInlineChanges(H);};var u=function(H){j=H.slice();return A.addChangesToPersistence(H,r);};var v=function(){var H=A.getNewAppVariantId();return o.createAppVariant(H).catch(function(J){var M=J.messageKey;if(!M){M="MSG_SAVE_APP_VARIANT_FAILED";}if(J.saveAsFailed){A.removeChangesFromPersistence(j,r);}return A.catchErrorDialog(J,M,H);});};var w=function(H){k=null;k=m({},H.response);return o.clearRTACommandStack(C);};var x=function(){var H=F.getUshellContainer();if(H&&C){H.setDirtyFlag(false);}};var y=function(H){x();I=A.isS4HanaCloud(H);var J=A.buildSuccessInfo(k.id,e,I);return o.showSuccessMessage(J);};var z=function(){var H=A.buildFinalSuccessInfoS4HANACloud();return o.showSuccessMessage(H);};var E=function(){B.show();if(I){return t(k.id,k.reference).then(function(H){B.hide();return f.call(this,e,null,h).then(function(){e=false;return b(H,k.id).then(z);});}.bind(this));}B.hide();return f.call(this,e,I,h);};sap.ui.require(["sap/ui/rta/appVariant/AppVariantManager"],function(H){if(!o){o=new H({rootControl:r,commandSerializer:c,layer:h});}return p().then(q).then(u).then(v).then(w).then(G).then(y).then(E.bind(this)).then(n).catch(function(J){if(!J){return false;}return f.call(this,null,I,h).then(n);}.bind(this));}.bind(this));}.bind(this));},onDeleteFromOverviewDialog:function(e,C,h){var i;return new Promise(function(j){sap.ui.require(["sap/ui/rta/appVariant/AppVariantManager"],function(k){if(!o){o=new k({rootControl:r,commandSerializer:c,layer:h});}var l=function(){return o.deleteAppVariant(e).catch(function(E){var M=E.messageKey;if(!M){M="MSG_DELETE_APP_VARIANT_FAILED";}return A.catchErrorDialog(E,M,e);});};var n=function(){A.closeOverviewDialog();var v=A.buildDeleteSuccessMessage(e);return o.showSuccessMessage(v);};var p=function(){var M=C?"MSG_DO_NOT_CLOSE_BROWSER_CURRENTLY_ADAPTING":"MSG_DO_NOT_CLOSE_BROWSER";_=window.onbeforeunload;window.onbeforeunload=A.handleBeforeUnloadEvent;return A.showMessage(M);};var q=function(v){i=A.isS4HanaCloud(v);if(i){return p().then(function(){return T(e);}).then(function(w){return R.call(this,null,h).then(function(){return d(w,e);});}.bind(this));}B.show();return Promise.resolve();};var u=function(){if(i){s();}B.hide();return R.call(this,null,i,h).then(j);};if(C){A.closeOverviewDialog();A.navigateToFLPHomepage();}return G().then(q.bind(this)).then(l).then(n).then(u.bind(this)).catch(function(){return f.call(this,null,i,h).then(j);}.bind(this));}.bind(this));}.bind(this));}};});
