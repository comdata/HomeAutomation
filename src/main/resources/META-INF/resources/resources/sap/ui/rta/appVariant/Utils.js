/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/LrepConnector","sap/ui/rta/appVariant/AppVariantUtils","sap/ui/fl/registry/Settings","sap/base/i18n/ResourceBundle"],function(L,A,S,R){"use strict";var U={};var m=sap.ui.require.toUrl("sap/ui/rta/appVariant/manageApps/")+"webapp";var i=R.create({url:m+"/i18n/i18n.properties"});U.sendRequest=function(r,o){var l=L.createConnector();return l.send(r,o);};U._checkNavigationSupported=function(n){var N=sap.ushell.Container.getService("CrossApplicationNavigation");return N.getLinks(n);};U._checkAppType=function(o,a){if(o&&a){return i.getText("MAA_ORIGINAL_TYPE");}else if(a){return i.getText("MAA_APP_VARIANT_TYPE");}else if(o){return i.getText("MAA_ORIGINAL_TYPE");}return undefined;};U._calculateCurrentStatus=function(a,s){var n=A.getNewAppVariantId();if(s==='R'){return i.getText("MAA_OPERATION_IN_PROGRESS");}else if(n===a){A.setNewAppVariantId(null);if(s!=='E'){return i.getText("MAA_NEW_APP_VARIANT");}}};U._checkMenuItemOptions=function(p,a){var o={};if(p.isKeyUser){if(p.isOriginal){o.delAppVarButtonEnabled=false;o.delAppVarButtonVisibility=false;return o;}if(p.appVarStatus==='U'||p.appVarStatus==='E'||p.appVarStatus==='R'){o.saveAsButtonEnabled=false;}if(a){if(p.isS4HanaCloud){o.delAppVarButtonEnabled=true;o.delAppVarButtonVisibility=true;}else{o.delAppVarButtonEnabled=false;o.delAppVarButtonVisibility=true;}}else{o.delAppVarButtonVisibility=true;if(p.appVarStatus==='R'){o.delAppVarButtonEnabled=false;}else{o.delAppVarButtonEnabled=true;}}}else{o.delAppVarButtonEnabled=false;o.delAppVarButtonVisibility=false;}return o;};U._getNavigationInfo=function(p){var n={};var s=p.startWith.semanticObject;var a=p.startWith.action;var P=p.startWith.parameters;var N={semanticObject:s,action:a,params:P};return this._checkNavigationSupported(N).then(function(r){var d;if(r.length&&p.isKeyUser){n.adaptUIButtonEnabled=true;if(p.appVarStatus==='R'||p.appVarStatus==='U'||p.appVarStatus==='E'){n.adaptUIButtonEnabled=false;}}else{n.adaptUIButtonEnabled=false;}d=this._checkMenuItemOptions(p,n.adaptUIButtonEnabled);n.semanticObject=s;n.action=a;if(P){Object.keys(P).forEach(function(b){if(P[b].value){P[b]=P[b].value;}});n.params=P;}n=Object.assign({},n,d);return n;}.bind(this));};U._prepareAppVariantAttributes=function(a){return{appId:a.appId,title:a.title||'',subTitle:a.subTitle||'',description:a.description||'',icon:a.iconUrl||'',iconText:a.iconText,isOriginal:a.isOriginal,isAppVariant:a.isAppVariant,descriptorUrl:a.descriptorUrl,appVarStatus:a.appVarStatus};};U.getAppVariantOverviewAttributes=function(a,k){var o;var I=a.iconUrl;if(I&&sap.ui.core.IconPool.isIconURI(I)){a.iconText=I.split('//')[1];}o=this._prepareAppVariantAttributes(a);o.isKeyUser=k;o.typeOfApp=this._checkAppType(a.isOriginal,a.isAppVariant);o.currentStatus=this._calculateCurrentStatus(a.appId,a.appVarStatus);var b;return S.getInstance().then(function(s){b=A.isS4HanaCloud(s);o.isS4HanaCloud=b;var p={isKeyUser:k,isOriginal:a.isOriginal,isS4HanaCloud:b,appVarStatus:a.appVarStatus};if(a.hasStartableIntent){p.startWith=a.startWith;return this._getNavigationInfo(p).then(function(n){o=Object.assign({},o,n);return o;});}o.adaptUIButtonEnabled=false;var d=this._checkMenuItemOptions(p,false);o=Object.assign({},o,d);return Promise.resolve(o);}.bind(this));};U.getAppVariantOverview=function(r,k){var l=k?'CUSTOMER*':'VENDOR';var s='/sap/bc/lrep/app_variant_overview/?sap.app/id='+r+'&layer='+l;return this.sendRequest(s,'GET').then(function(o){var a=[];var b;if(o.response&&o.response.items){b=o.response.items;}else{return Promise.resolve([]);}b.forEach(function(c){if(!c.isDescriptorVariant){a.push(this.getAppVariantOverviewAttributes(c,k));}},this);return Promise.all(a).then(function(c){return c;});}.bind(this));};U.getDescriptor=function(d){return this.sendRequest(d,'GET').then(function(r){return r.response;});};return U;},true);
