/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
(function(g){"use strict";var o;if(g.module){o=g.module;g.module=undefined;}sap.ui.define(['sap/ui/thirdparty/jquery','sap/ui/base/Object','sap/ui/core/Element','sap/ui/core/mvc/View','sap/ui/test/matchers/Ancestor','sap/ui/test/matchers/MatcherFactory','sap/ui/test/pipelines/MatcherPipeline','sap/ui/test/_OpaLogger'],function($,U,a,V,A,M,b,_){var m=new M();var c=new b();var C=["id","viewName","viewId","controlType","searchOpenDialogs"];var O=U.extend("sap.ui.test.OpaPlugin",{constructor:function(){this._oLogger=_.getLogger("sap.ui.test.Opa5");},getAllControls:function(f,s){var e=a.registry.filter(d(f));this._oLogger.debug("Found "+e.length+" controls"+(f?" of type '"+(s||f)+"'":"")+" in page");return e;},getView:function(v){var e=this.getAllControls(V,"View");var f=e.filter(function(h){return h.getViewName()===v;});this._oLogger.debug("Found "+f.length+" views with viewName '"+v+"'");if(f.length>1){f=f.filter(function(h){var i=h.$();return i.length>0&&i.is(":visible")&&i.css("visibility")!=="hidden";});this._oLogger.debug("Found "+f.length+" visible views with viewName '"+v+"'");if(f.length!==1){this._oLogger.debug("Cannot identify controls uniquely. Please provide viewId to locate the exact view.");f=[];}}return f[0];},_getMatchingView:function(e){var v=null;var s;if(e.viewName){var f=(e.viewNamespace||"")+"."+(e.viewName||"");s=f.replace(/\.+/g,'.').replace(/^\.|\.$/g,"");}if(e.viewId){var h=a.registry.get(e.viewId);if(h instanceof V&&(!s||h.getViewName()===s)){v=h;}}else{v=this.getView(s);}this._oLogger.debug("Found "+(v?"":"no ")+"view with ID '"+e.viewId+"' and viewName '"+s+"'");return v;},getControlInView:function(e){var v=this._getMatchingView(e);var s=typeof e.id==="string";if(!v){return s?null:[];}var f=v.getViewName();var F=e.fragmentId?e.fragmentId+O.VIEW_ID_DELIMITER:"";if($.isArray(e.id)){var h=[];var u=[];e.id.map(function(I){return F+I;}).forEach(function(I){var j=v.byId(I);if(j){h.push(j);}else{u.push(I);}});var i=u.length?". Found no controls matching the subset of IDs "+u:"";this._oLogger.debug("Found "+h.length+" controls with ID contained in "+e.id+" in view '"+f+"'"+i);return h;}if(s){var I=F+e.id;var j=v.byId(I)||null;this._oLogger.debug("Found "+(j?"":"no ")+"control with ID '"+I+"' in view '"+f+"'");return j;}var k=this.getAllControlsWithTheParent(v,e.controlType,e.sOriginalControlType);var l=$.type(e.id)==="regexp";if(l){k=k.filter(function(j){var n=this._getUnprefixedControlId(j.getId(),v.getId(),e.fragmentId);return e.id.test(n);}.bind(this));}this._oLogger.debug("Found "+k.length+" controls of type "+e.sOriginalControlType+(l?" with ID matching "+e.id:"")+" in view '"+f+"'");return k;},getAllControlsWithTheParent:function(p,f,s){var e=new A(p);return this._filterUniqueControlsByCondition(this.getAllControls(f,s),e);},getAllControlsInContainer:function(e,f,s,h){var i=d(f),j=this._filterUniqueControlsByCondition(this._getControlsInContainer(e),i);this._oLogger.debug("Found "+j.length+" controls in "+(h?h:"container")+" with controlType '"+s+"'");return j;},_getControlsInStaticArea:function(e){var v=this._getControlsInContainer($("#sap-ui-static"))||[];if(e.id){v=this._filterUniqueControlsByCondition(v,function(f){var u=f.getId();var i=this._getMatchingView(e);if(i){if(this._isControlInView(f,i.getViewName())){u=this._getUnprefixedControlId(f.getId(),i.getId(),e.fragmentId);}}var I=false;if(typeof e.id==="string"){I=u===e.id;}if($.type(e.id)==="regexp"){I=e.id.test(u);}if($.isArray(e.id)){I=e.id.filter(function(s){return s===u;}).length>0;}return I;}.bind(this));this._oLogger.debug("Found "+(v.length?v.length:"no")+" controls in the static area with ID matching '"+e.id+"'"+(e.fragmentId?" and fragmentId: '"+e.fragmentId+"'":""));}if(v.length&&e.controlType){var h=d(e.controlType);v=this._filterUniqueControlsByCondition(v,h);this._oLogger.debug("Found "+(v.length?v.length:"no")+" controls in the static area with control type matching '"+e.controlType+"'");}if(e.id&&typeof e.id==="string"){return v[0]||null;}else{return v;}},_getControlsInContainer:function(j){return j.find("*").control();},_isControlInView:function(e,v){if(!e){return false;}if(e.getViewName&&e.getViewName()===v){return true;}else{return this._isControlInView(e.getParent(),v);}},getMatchingControls:function(e){var r=null;e=e||{};var h=this._modifyControlType(e);if(!h){return typeof e.id==="string"?r:[];}if(e.searchOpenDialogs){r=this._getControlsInStaticArea(e);}else if(e.viewName||e.viewId){r=this.getControlInView(e);}else if(e.id){r=this.getControlByGlobalId(e);}else if(e.controlType){r=this.getAllControls(e.controlType,e.sOriginalControlType);}else{r=this.getAllControls();}if(!r){return r;}var s=m.getStateMatchers({visible:e.visible,interactable:e.interactable,enabled:typeof e.enabled==="undefined"?e.interactable:e.enabled});var p=c.process({control:r,matchers:s});if(!p){if($.isArray(r)){return[];}if(r){return null;}return r;}return p;},_getFilteredControls:function(e){var v=this._filterControlsByCondition(e);return v===O.FILTER_FOUND_NO_CONTROLS?O.FILTER_FOUND_NO_CONTROLS:this._filterControlsByMatchers(e,v);},_getFilteredControlsByDeclaration:function(e){var v=this._filterControlsByCondition(e);var f=$.extend({},e,{useDeclarativeMatchers:true});return v===O.FILTER_FOUND_NO_CONTROLS?O.FILTER_FOUND_NO_CONTROLS:this._filterControlsByMatchers(f,v);},_filterControlsByCondition:function(e){var v=null;var p=this._isLookingForAControl(e);if(p){v=this.getMatchingControls(e);}var f=[typeof e.id==="string"&&!v,$.type(e.id)==="regexp"&&!v.length,$.isArray(e.id)&&(!v||v.length!==e.id.length),e.controlType&&$.isArray(v)&&!v.length,!e.id&&(e.viewName||e.viewId||e.searchOpenDialogs)&&!v.length];return f.some(Boolean)?O.FILTER_FOUND_NO_CONTROLS:v;},_filterControlsByMatchers:function(e,v){var f=e.useDeclarativeMatchers?m.getFilteringMatchers(e):e.matchers;var p=this._isLookingForAControl(e);var r=null;if((v||!p)&&f){r=c.process({matchers:f,control:v});if(!r){return O.FILTER_FOUND_NO_CONTROLS;}}else{r=v;}return r;},getControlByGlobalId:function(e){var h=d(e.controlType);if(typeof e.id==="string"){var f=a.registry.get(e.id)||null;if(f&&!h(f)){this._oLogger.error("A control with global ID '"+e.id+"' is found but does not have required controlType '"+e.sOriginalControlType+"'. Found control is '"+f+"' but null is returned instead");return null;}this._oLogger.debug("Found "+(f?"":"no ")+"control with the global ID '"+e.id+"'");return f;}var i=[];var j=$.type(e.id)==="regexp";if(j){a.registry.forEach(function(E,I){if(e.id.test(I)){i.push(I);}});}else if($.isArray(e.id)){i=e.id;}var k=[];var u=[];i.forEach(function(I){var f=a.registry.get(I);if(f&&h(f)&&!f.bIsDestroyed){k.push(f);}else{u.push(I);}});var s=!j&&u.length?". Found no controls of matching the subset of IDs "+u:"";this._oLogger.debug("Found "+k.length+" controls of type "+e.sOriginalControlType+(j?" with ID matching '":" with ID contained in '")+e.id+s);return k;},getControlConstructor:function(s){if(sap.ui.lazyRequire._isStub(s)){this._oLogger.debug("The control type "+s+" is currently a lazy stub.");return null;}var f=$.sap.getObject(s);if(!f){this._oLogger.debug("The control type "+s+" is undefined.");return null;}if(typeof f!=="function"){this._oLogger.debug("The control type "+s+" must be a function.");return null;}return f;},_isLookingForAControl:function(e){return Object.keys(e).some(function(k){return C.indexOf(k)!==-1&&!!e[k];});},_filterUniqueControlsByCondition:function(e,f){return e.filter(function(h,p,i){var k=!!f(h);return k&&i.indexOf(h)===p;});},_modifyControlType:function(e){var v=e.controlType;if(typeof v!=="string"){if(v&&v._sapUiLazyLoader){this._oLogger.debug("The control type is currently a lazy stub");return false;}return true;}var f=this.getControlConstructor(v);if(!f){return false;}e.sOriginalControlType=v;e.controlType=f;return true;},_getUnprefixedControlId:function(s,v,f){var u=s.replace(v+O.VIEW_ID_DELIMITER,"");if(f){if(u.startsWith(f+O.VIEW_ID_DELIMITER)){u=u.replace(f+O.VIEW_ID_DELIMITER,"");}else{u="";}}return u;}});function d(f){return function(e){if(!f){return true;}return e instanceof f;};}O.FILTER_FOUND_NO_CONTROLS="FILTER_FOUND_NO_CONTROL";O.VIEW_ID_DELIMITER="--";return O;});if(o){g.module=o;}})(window);
