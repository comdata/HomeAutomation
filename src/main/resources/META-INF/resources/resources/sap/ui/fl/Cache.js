/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/LrepConnector","sap/ui/fl/Utils","sap/base/strings/formatMessage","sap/base/Log","sap/ui/thirdparty/jquery","sap/base/util/LoaderExtensions","sap/base/util/ObjectPath","sap/ui/fl/apply/_internal/ConnectorResultMerger"],function(L,U,f,a,q,b,O,C){"use strict";var c=function(){};c._isOn=true;c._entries={};c._switches={};c._oFlexDataPromise=undefined;c.getSwitches=function(){return c._switches;};c.isActive=function(){return c._isOn;};c.setActive=function(A){c._isOn=A;};c.getFlexDataPromise=function(){return c._oFlexDataPromise;};c.getEntries=function(){return c._entries;};c.clearEntries=function(){c._entries={};};c.getEntry=function(s,A){if(!c._entries[s]){c._entries[s]={};}if(!c._entries[s][A]){c._entries[s][A]={file:{changes:{changes:[],contexts:[],variantSection:{},ui2personalization:{}}}};}return c._entries[s][A];};c.clearEntry=function(s,A){c.getEntry(s,A);c._entries[s][A]={};};c._deleteEntry=function(s,A){if(c._entries[s]&&c._entries[s][A]){delete c._entries[s][A];}if(q.isEmptyObject(c._entries[s])){delete c._entries[s];}};c.getChangesFillingCache=function(l,m,p,i){var s=m.name;var A=m.appVersion||U.DEFAULT_APP_VERSION;var o=c.getEntry(s,A);var d;p=p||{};p.isTrial=U.isTrialSystem();if(o.promise&&!i){return o.promise;}var e=c._getChangesFromBundle(p);if(p.cacheKey==="<NO CHANGES>"){d=e.then(function(h){o.file={changes:{changes:h,contexts:[],variantSection:{},ui2personalization:{}},componentClassName:s};return o.file;}).then(function(r){if(p.isTrial&&l instanceof L){return l.enableFakeConnectorForTrial(m,r);}return r;});o.promise=d;return d;}var F=l.loadChanges(m,p);var g=F.then(function(r){return r;},function(E){var M="";if(E.messages&&E.messages.length!==0&&E.messages[0].text){M=E.messages[0].text;}var h=f("Loading changes for {0} failed!\nError code: {1}\nMessage: {2}",m.name,E.code||"",M);a.error(h);return Promise.resolve({changes:{changes:[],variantSection:{},ui2personalization:{}}});});d=Promise.all([e,g]).then(function(v){var h=v[0];var j=v[1];if(j&&j.changes){var k=[{changes:h},Object.assign({},j.changes)];j.changes.changes=C._concatChanges(k);}o.file=j;return o.file;},function(h){c._deleteEntry(s,A);throw h;});o.promise=d;c._oFlexDataPromise=F;return d;};c._getChangesFromBundle=function(p){var d=p.appName;if(!d){return Promise.resolve([]);}var r=p.appName.replace(/\./g,"/")+"/changes/changes-bundle.json";var g=!!sap.ui.loader._.getModuleState(r);if(g){return Promise.resolve(b.loadResource(r));}var o=sap.ui.getCore().getConfiguration();if(o.getDebug()||o.getComponentPreload()==="off"||o.isFlexBundleRequestForced()){try{return Promise.resolve(b.loadResource(r));}catch(e){a.warning("flexibility did not find a changesBundle.json  for the application");}}return Promise.resolve([]);};c.NOTAG="<NoTag>";c._trimEtag=function(s){return s.replace(/(^W\/|")/g,'');};c._concatControlVariantIdWithCacheKey=function(s,d){if(!d){return s;}return s===c.NOTAG?s.replace(/>$/,''.concat('-',d,'>')):s.concat('-',d);};c.getCacheKey=function(m,A){if(!m||!m.name||!m.appVersion||!A){a.warning("Not all parameters were passed to determine a flexibility cache key.");return Promise.resolve(c.NOTAG);}return this.getChangesFillingCache(L.createConnector(),m).then(function(w){if(w&&w.etag){return c._trimEtag(w.etag);}return c.NOTAG;}).then(function(s){var v=A.getModel(U.VARIANT_MODEL_NAME);var d=v?v.getCurrentControlVariantIds():[];return c._concatControlVariantIdWithCacheKey(s,d.join("-"));});};c._getChangeArray=function(o){var s=o.name;var A=o.appVersion||U.DEFAULT_APP_VERSION;var e=c.getEntry(s,A);return e.file.changes.changes;};c.addChange=function(o,d){var e=c._getChangeArray(o);if(!e){return;}e.push(d);};c.setVariantManagementSection=function(o,v){var s=o.name;var A=o.appVersion||U.DEFAULT_APP_VERSION;var e=c.getEntry(s,A);if(!O.get("file.changes.variantSection",e)){return;}e.file.changes.variantSection=v;};c.updateChange=function(o,d){var e=c._getChangeArray(o);if(!e){return;}for(var i=0;i<e.length;i++){if(e[i].fileName===d.fileName){e.splice(i,1,d);break;}}};c.deleteChange=function(o,d){var e=c._getChangeArray(o);if(!e){return;}for(var i=0;i<e.length;i++){if(e[i].fileName===d.fileName){e.splice(i,1);break;}}};c.removeChanges=function(o,d){var e=c.getEntry(o.name,o.appVersion);e.file.changes.changes=e.file.changes.changes.filter(function(g){return d.indexOf(g.fileName)===-1;});var v=e.file.changes.variantSection;Object.keys(v).forEach(function(i){v[i].variants.forEach(function(V){V.controlChanges=V.controlChanges.filter(function(g){return d.indexOf(g.getFileName())===-1;});});});};c.getPersonalization=function(r,A,s,i){var m={name:r,appVersion:A};return this.getChangesFillingCache(L.createConnector(),m).then(function(R){if(!R||!R.changes||!R.changes.ui2personalization||!R.changes.ui2personalization[s]){return i?undefined:[];}if(!i){return R.changes.ui2personalization[s]||[];}return R.changes.ui2personalization[s].filter(function(e){return e.itemName===i;})[0];});};c.setPersonalization=function(p){if(!p||!p.reference||!p.containerKey||!p.itemName||!p.content){return Promise.reject("not all mandatory properties were provided for the storage of the personalization");}return L.createConnector().send("/sap/bc/lrep/ui2personalization/","PUT",p,{}).then(this._addPersonalizationToEntries.bind(this,p));};c._addPersonalizationToEntries=function(p){Object.keys(this._entries[p.reference]).forEach(function(v){var e=this._entries[p.reference][v];var P=e.file.changes.ui2personalization;if(!P[p.containerKey]){P[p.containerKey]=[];}P[p.containerKey].push(p);}.bind(this));};c.deletePersonalization=function(r,s,i){if(!r||!s||!i){return Promise.reject("not all mandatory properties were provided for the storage of the personalization");}var u="/sap/bc/lrep/ui2personalization/?reference=";u+=r+"&containerkey="+s+"&itemname="+i;return L.createConnector().send(u,"DELETE",{}).then(this._removePersonalizationFromEntries.bind(this,r,s,i));};c._removePersonalizationFromEntries=function(r,s,i){var d=[];Object.keys(this._entries[r]).forEach(function(A){var g=this.getPersonalization(r,A,s);var G=this.getPersonalization(r,A,s,i);var D=Promise.all([g,G]).then(function(p){var I=p[0];var t=p[1];var n=I.indexOf(t);I.splice(n,1);});d.push(D);}.bind(this));return Promise.all(d);};return c;},true);
