/*!
 * OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(['sap/ui/thirdparty/URI','sap/ui/Device','sap/ui/performance/trace/Passport','sap/ui/performance/trace/Interaction','sap/ui/performance/XHRInterceptor','sap/ui/performance/BeaconRequest','sap/base/util/Version'],function(U,D,P,I,X,B,V){"use strict";var f=false,b,o,i,R=P.getRootId(),H=window.location.host,C=D.os.name+"_"+D.os.version,a=D.browser.name+"_"+D.browser.version,c=h(),A="",s="",F,S=0,p="undetermined",d="undetermined_startup_0",e,g;function h(){var y=0;if(D.system.combi){y=1;}else if(D.system.desktop){y=2;}else if(D.system.tablet){y=4;}else if(D.system.phone){y=3;}return y;}function j(T){var y=new Date(T);return y.toISOString().replace(/[^\d]/g,'');}function k(y){var z=new U(y).host();return z&&z!==H;}function l(){if(!k(arguments[1])){if(!F){F=P.getTransactionId();}this.setRequestHeader("SAP-PASSPORT",P.header(P.traceFlags(),R,P.getTransactionId(),p,d));}}function m(){if(!k(arguments[1])){if(e&&g){this.setRequestHeader("SAP-Perf-FESRec",e);this.setRequestHeader("SAP-Perf-FESRec-opt",g);e=null;g=null;F=P.getTransactionId();}}}function n(y,z){return[r(R,32),r(F,32),r(y.navigation,16),r(y.roundtrip,16),r(z.timeToInteractive,16),r(y.completeRoundtrips,8),r(d,40,true),r(y.networkTime,16),r(y.requestTime,16),r(C,20),"SAP_UI5"].join(",");}function q(y,z){return[r(z.appNameShort,20,true),r(z.stepName,20,true),"",r(a,20),r(y.bytesSent,16),r(y.bytesReceived,16),"","",r(y.processing,16),y.requestCompression?"X":"","","","","",r(y.busyDuration,16),"",r(c,1),"",r(j(y.start),20),r(z.appNameLong,70,true)].join(",");}function r(y,L,z){if(!y){y=y===0?"0":"";}else if(typeof y==="number"){var E=y;y=Math.round(y).toString();if(y.length>L||E<0){y="-1";}}else{y=z?y.substr(-L,L):y.substr(0,L);}return y;}function t(y){var z=new V(y);return"@"+z.getMajor()+"."+z.getMinor()+"."+z.getPatch();}function u(y,z){e=n(y,z);g=q(y,z);}function v(y,z){var E=x.onBeforeCreated({stepName:y.trigger+"_"+y.event,appNameLong:y.stepComponent||y.component,appNameShort:y.stepComponent||y.component,timeToInteractive:y.duration},y);if(o||y.requests.length>0||z){u(y,E);if(o){F=null;}}if(o&&e&&g){o.append("SAP-Perf-FESRec",e+"SAP-Perf-FESRec-opt"+g);clearTimeout(i);i=setTimeout(w,60000);}var G=I.getPending();if(G){if(s!=G.appVersion){s=G.appVersion;A=s?t(s):"";}}p=G?G.component+A:undefined;d=G?G.trigger+"_"+G.event+"_"+S:undefined;S++;}function w(){o.send();clearTimeout(i);i=setTimeout(w,60000);}var x={};x.getBeaconURL=function(){return b;};x.setActive=function(y,z){if(y&&!f){o=z?B.isSupported()&&new B({url:z}):null;b=z;f=true;P.setActive(true);I.setActive(true);X.register("PASSPORT_HEADER","open",l);if(!o){X.register("FESR","open",m);}I.onInteractionFinished=v;}else if(!y&&f){f=false;I.setActive(false);X.unregister("FESR","open");if(X.isRegistered("PASSPORT_HEADER","open")){X.register("PASSPORT_HEADER","open",function(){this.setRequestHeader("SAP-PASSPORT",P.header(P.traceFlags(),R,P.getTransactionId()));});}if(o){o.send();clearTimeout(i);i=null;o=null;b=null;}I.onInteractionFinished=null;}};x.getActive=function(){return f;};x.onBeforeCreated=function(y,z){return{stepName:y.stepName,appNameLong:y.appNameLong,appNameShort:y.appNameShort,timeToInteractive:y.timeToInteractive};};return x;});
