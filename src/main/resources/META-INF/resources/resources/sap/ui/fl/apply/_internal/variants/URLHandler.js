/*
 * ! OpenUI5
 * (c) Copyright 2009-2019 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/core/Component","sap/ui/fl/Utils","sap/ui/core/routing/History","sap/ui/core/routing/HashChanger","sap/base/Log","sap/base/util/deepEqual","sap/base/util/merge","sap/base/util/isEmptyObject","sap/ui/base/ManagedObjectObserver","sap/ui/thirdparty/hasher"],function(C,U,H,a,L,d,m,i,M,h){"use strict";function g(o,N){var f=N.params[e.variantTechnicalParameterName];return f.reduce(function(r,v){var V=o.getVariantManagementReference(v).variantManagementReference;if(V&&o.oData[V].currentVariant!==v){r.updateRequired=true;if(o.oData[V].currentVariant!==o.oData[V].defaultVariant){r.currentVariantReferences.push(o.oData[V].currentVariant);}}else{r.currentVariantReferences.push(v);}return r;},{updateRequired:false,currentVariantReferences:[]});}function n(o,N){var u=U.getUshellContainer();var S=u.getService("ShellNavigation");try{var f=u.getService("URLParsing");var j=f.parseShellHash(N);var r=j&&j.params.hasOwnProperty(e.variantTechnicalParameterName);if(r){var k=g(o,j);if(k.updateRequired){e.update({updateURL:!o._bDesignTimeMode,parameters:k.currentVariantReferences,updateHashEntry:true,model:o});}if(o._bDesignTimeMode){e.clearAllVariantURLParameters({model:o});}}}catch(E){L.error(E.message);}return S.NavigationFilterStatus.Continue;}function s(o,S){var f=S?"registerNavigationFilter":"unregisterNavigationFilter";var u=U.getUshellContainer();if(u){u.getService("ShellNavigation")[f](n.bind(null,o));}}function b(p){var P=U.getParsedURLHash(e.variantTechnicalParameterName);if(P.params){var t=U.getTechnicalParametersForComponent(p.model.oAppComponent);if(!t){L.warning("Component instance not provided, so technical parameters in component data and browser history remain unchanged");}if(p.parameters.length===0){delete P.params[e.variantTechnicalParameterName];t&&delete t[e.variantTechnicalParameterName];}else{P.params[e.variantTechnicalParameterName]=p.parameters;t&&(t[e.variantTechnicalParameterName]=p.parameters);}if(p.silent){h.changed.active=false;h.replaceHash(U.getUshellContainer().getService("URLParsing").constructShellHash(P));h.changed.active=true;}else{var o=U.getUshellContainer().getService("CrossApplicationNavigation");o.toExternal({target:{semanticObject:P.semanticObject,action:P.action,context:P.contextRaw},params:P.params,appSpecificRoute:P.appSpecificRoute,writeHistory:false});}}}function c(p){var r={index:-1};var u=U.getParsedURLHash().params;if(u){r.parameters=[];if(p.model._bDesignTimeMode){u[e.variantTechnicalParameterName]=e.getStoredHashParams(p);}if(Array.isArray(u[e.variantTechnicalParameterName])){u[e.variantTechnicalParameterName]=u[e.variantTechnicalParameterName].map(decodeURIComponent);u[e.variantTechnicalParameterName].some(function(P,I){if(p.model.oVariantController.getVariant(p.vmReference,P)){r.index=I;return true;}});}}return m(r,u&&u[e.variantTechnicalParameterName]&&{parameters:u[e.variantTechnicalParameterName]});}var e={variantTechnicalParameterName:"sap-ui-fl-control-variant-id",initialize:function(p){var u=U.getParsedURLHash().params;p.model._oHashData={hashParams:(u&&u[e.variantTechnicalParameterName])||[],controlPropertyObservers:[],variantControlIds:[]};s(p.model,true);},updateVariantInURL:function(p){var u=e.removeURLParameterForVariantManagement(p);if(!u.parameters){return;}var P=u.parameters||[];var I=u.index;var f=p.newVReference===p.model.oData[p.vmReference].defaultVariant;if(!f){if(I===-1){P=P.concat([p.newVReference]);}else{P=P.slice(0,I).concat([p.newVReference],P.slice(I));}}if(!f||I>-1){e.update({parameters:P,updateURL:!p.model._bDesignTimeMode,updateHashEntry:true,model:p.model});}},removeURLParameterForVariantManagement:function(p){var v=c(p);if(v.index>-1){v.parameters.splice(v.index,1);}return v;},attachHandlers:function(p){function o(){return p.model._oVariantSwitchPromise.then(function(){p.model._oHashData.controlPropertyObservers.forEach(function(O){O.destroy();});s(p.model,false);p.model.oChangePersistence.resetVariantMap();p.model.destroy();p.model.oComponentDestroyObserver.unobserve(p.model.oAppComponent,{destroy:true});p.model.oComponentDestroyObserver.destroy();});}if(!p.model.oComponentDestroyObserver&&p.model.oAppComponent instanceof C){p.model.oComponentDestroyObserver=new M(o.bind(null));p.model.oComponentDestroyObserver.observe(p.model.oAppComponent,{destroy:true});}if(p.updateURL){p.model._oHashData.variantControlIds.push(p.vmReference);}},update:function(p){if(!p||!Array.isArray(p.parameters)){L.info("Variant URL parameters could not be updated since invalid parameters were received");return;}if(p.updateURL){b(p);}if(p.updateHashEntry&&!i(p.model)){p.model._oHashData.hashParams=p.parameters;}},getStoredHashParams:function(p){return Array.prototype.slice.call(p.model._oHashData.hashParams);},handleModelContextChange:function(p){var f="modelContextChange";function j(E,P){var v=P.model.getVariantManagementReferenceForControl(E.getSource());var V=P.model._oHashData.variantControlIds;var I=V.indexOf(v);if(I>-1){V.slice(I).forEach(function(k){if(c({vmReference:k,model:p.model}).index===-1){P.model.switchToDefaultForVariantManagement(k);}});}}var o=new M(function(E){if(E.current===true&&E.old===false){E.object.attachEvent(f,{model:p.model},j);}else if(E.current===false&&E.old===true){E.object.detachEvent(f,j);}});o.observe(p.vmControl,{properties:["resetOnContextChange"]});p.model._oHashData.controlPropertyObservers.push(o);if(p.vmControl.getResetOnContextChange()!==false){p.vmControl.attachEvent(f,{model:p.model},j);}},clearAllVariantURLParameters:function(p){e.update({updateURL:true,parameters:[],updateHashEntry:false,model:p.model});}};return e;},true);
